// ============================================================================
// 再见珍珠 - 项目计划
// ============================================================================

#import "template.typ": *

#show: initialize-document(
  title: "再见珍珠",
  subtitle: "项目计划书（最终版）",
  authors: ("windlandneko",),
)

#pagebreak()

= 项目概述

=== 项目名称：

*再见珍珠（Rewind Pearl）*

=== 项目类型

横板解谜 + 视觉小说 + 弹幕游戏的混合体

=== 核心概念

以丁真为主角的抽象叙事游戏，采用像素风横板解谜、视觉小说对话系统，融合时间回溯机制和东方风弹幕元素。游戏通过碎片化的剧情、抽象的叙事和多结局分支，为玩家提供独特的游戏体验。

=== 目标平台

- *平台*：Web（HTML5 + JavaScript）
- *输入*：键盘 + 鼠标
- *兼容性*：现代浏览器（Chrome、Firefox、Edge），不支持 IE
- *分辨率*：响应式设计，支持 1280×720 到 1920×1080

= 核心玩法

== 游戏循环

#styled-table(
  columns: (0.5fr, 2fr),
  headers: ([阶段], [内容]),
  rows: (
    ([1], [进入横板解谜关卡，侧重环境交互、跳跃、机关操作]),
    ([2], [关卡结尾触发视觉小说段落，推进剧情]),
    ([3], [达到节点后触发 Boss 弹幕战]),
    ([4], [根据线索收集和战斗表现判定结局分支]),
  ),
)

== 特殊机制

=== 好想抽锐刻

丁真半分钟不抽锐刻五代就会"发癫"，玩家需在倒计时内找到锐刻五代物品进行交互，否则触发关卡失败。这一机制作为游戏的核心张力元素，贯穿所有关卡。

=== 葬送的芙蓉王

王源因 CERN 实验获得"时间回溯"能力，可在当前位置回到过去的时间点。该机制是游戏的核心谜题和战斗要素。

玩家在初次挑战 Boss 时会失败（假结局），之后可以：
- 利用回溯机制重走关卡
- 发现隐藏道路和线索
- 最终找到"回溯能量核心"并摧毁

=== 打破回溯方法

玩家理解回溯机制后，可以：
- 在关卡中发现隐藏道路
- 进入特殊关卡
- 寻找并摧毁回溯能量核心
- 解决 CERN 引发的异变

== 关卡设计

=== 关卡特点

- 独立关卡设计，每关有独特的主题和机制
- 强调环境交互（检视物品、触发机关）
- 包含跑酷元素和解谜要素
- 隐藏线索用于推动"真相进度"

=== 关卡结构

- *Prologue*：序章，介绍基本操作和剧情背景
- *Stage 1-5*：主线关卡，逐步展开故事
- *Extra Stages*：隐藏关卡，包含真结局线索
- *Boss 战*：弹幕对战，考验玩家反应和策略

= 剧情分支与结局

== 假结局

丁真挑战王源，起初占上风。王源使用秘密武器，丁真遇到几十个王源的围殴（这些都是未来回溯回来的他自己），拼尽全力仍无法战胜。

== 普通结局

重来后，丁真借助回溯能力重走关卡，寻得隐藏道路，发现回溯源于 CERN 的异变。破坏 CERN 后回溯能力消失，最终与王源进行正常的弹幕对战并收束故事。

== 真结局

玩家在重走关卡期间收集足够线索（可交互物品、记忆碎片），在最终对战后揭示 CERN 的真相。丁真告知王源真相并与之和解，大家一起包饺子。

== 彩蛋结局 A（致敬星际拓荒）

若玩家在回溯过程中设法打破过去自己的行动轨迹，将触发时空结构崩坏的实验性结局，呈现规则崩溃的视觉表现。

== 彩蛋结局 B（致敬东方 Project）

击败具备回溯能力的王源后，进入"还是 STG 大神"的致敬彩蛋。

= 技术方案

== 前端技术栈

#styled-table(
  columns: (1fr, 2fr),
  headers: ([技术], [用途]),
  rows: (
    ([HTML5], [页面结构]),
    ([CSS3], [样式与动画]),
    ([ES6+ JavaScript], [游戏逻辑]),
    ([Canvas 2D], [主要渲染引擎]),
    ([WebGL], [弹幕性能优化（备用）]),
    ([Web Audio API], [音频播放]),
  ),
)

== 核心系统架构

=== 游戏引擎（Game2D.js）

- *双循环架构*：逻辑更新循环（固定时间步长）+ 渲染循环（requestAnimationFrame）
- *游戏对象管理*：统一管理所有游戏实体，支持动态添加/移除
- *渲染组优化*：按对象类型分组缓存，减少每帧遍历开销
- *时间回溯系统*：记录游戏状态快照，支持完整的时间回溯机制
- *关卡系统*：关卡加载、切换、过渡效果
- *摄像机系统*：视差背景、平滑跟随、边界限制

=== 资源管理系统（Asset.js）

- *声明式管理*：基于 `manifest.json` 统一声明资源
- *自动类型识别*：根据扩展名自动选择加载器
- *进度跟踪*：实时加载进度回调
- *缓存机制*：内存中缓存已加载资源

=== 对话系统（Dialogue.js）

- *多风格支持*：现代风格（逐字显示）和东方风格（气泡对话）
- *事件驱动*：基于 JSON 的事件流控制剧情
- *角色系统*：动态角色管理，支持多表情切换
- *文本样式*：内联样式标记系统（`$样式类:文本$`）
- *键盘交互*：Enter/空格推进，Ctrl 快进，Esc 暂停

=== 音频管理（SoundManager.js）

- BGM 播放与循环
- 音效触发
- 音量控制
- 淡入淡出效果

=== 存档系统（SaveManager.js）

- 基于 LocalStorage 的本地存档
- 多用户存档支持
- 自动保存功能
- 存档加载与验证

=== 成就系统（AchievementManager.js）

- 成就解锁与追踪
- 成就通知
- 成就数据持久化
- 成就查看界面

=== 时间回溯系统（TimeTravel.js）

- 游戏状态快照记录
- 回溯预览与控制
- 幽灵玩家系统
- 时间线管理

== 数据格式

=== 关卡数据

```js
{
  introDialogue: 'chapter1_intro',  // 进入对话
  background: 'raincity0',          // 背景图
  spawnpoint: Vec2(100, 200),       // 出生点
  cameraHeight: 180,                 // 摄像机高度
  cameraBound: {                     // 摄像机边界
    x: 0, y: 0, width: 320, height: 180
  },
  tileData: [...],                   // 瓦片地图数据
  tilePalette: {...}                 // 瓦片调色板
}
```

=== 对话脚本（JSON）

```json
{
  "text_style": "modern",
  "auto_next_delay": 0,
  "events": [
    {
      "action": "add",
      "id": "dingzhen",
      "key": "dingzhen",
      "title": "丁真",
      "emotion": "normal",
      "position": "left"
    },
    {
      "action": "dialogue",
      "id": "dingzhen",
      "text": "你好，我是丁真。"
    }
  ]
}
```

=== 资源清单（manifest.json）

```json
{
  "audio": {
    "Home": "audio/Toby Fox - Home.mp3"
  },
  "background": {
    "raincity0": "background/raincity0.png"
  },
  "character": {
    "dingzhen": {
      "normal": "character/dingzhen/normal.png"
    }
  }
}
```

== 性能优化策略

- *渲染组缓存*：避免每帧过滤游戏对象
- *离屏 Canvas*：用于瓦片预渲染和特效合成
- *对象池*：复用游戏对象，减少 GC 压力
- *碰撞优化*：空间分区，减少碰撞检测次数
- *资源压缩*：图片 WebP 格式，音频 MP3 格式

= 团队分工

#styled-table(
  columns: (1fr, 1fr, 3fr),
  headers: ([姓名], [角色], [职责]),
  rows: (
    (
      [张振宇],
      [技术总监/程序员],
      [技术架构设计、核心引擎开发、游戏系统实现、代码规范制定、技术文档编写、性能优化、Bug 修复]
    ),
    (
      [牛浩羽],
      [测试/文案],
      [游戏测试、关卡逻辑验证、对话脚本编写（部分）、Bug 反馈]
    ),
    (
      [吴楠],
      [美术/文案],
      [角色精灵图绘制、立绘图片提供、背景素材提供（部分）、视觉风格设计]
    ),
  ),
)

= 开发计划与时间表

== 第一周（8月26日-8月30日）

#styled-table(
  columns: (1fr, 3fr, 1fr),
  headers: ([任务], [内容], [负责人]),
  rows: (
    ([项目启动], [角色确认、需求讨论、技术选型], [全员]),
    ([架构设计], [系统架构设计、模块划分、数据结构设计], [张振宇]),
    ([基础系统], [资源管理、事件系统、键盘输入], [张振宇]),
    ([对话系统], [对话框UI、事件解析、角色立绘], [张振宇]),
    ([美术资源], [角色设计、立绘绘制], [吴楠]),
    ([团队网站], [个人介绍页面、团队展示], [全员]),
  ),
)

*里程碑*：完成基础框架，对话系统可用，团队网站上线

== 第二周（8月31日-9月6日）

#styled-table(
  columns: (1fr, 3fr, 1fr),
  headers: ([任务], [内容], [负责人]),
  rows: (
    ([游戏引擎], [Game2D 核心逻辑、游戏循环、渲染系统], [张振宇]),
    ([物理系统], [碰撞检测、重力、运动], [张振宇]),
    ([游戏对象], [玩家、平台、可交互物体、敌人], [张振宇]),
    ([关卡系统], [关卡加载、瓦片地图、摄像机], [张振宇]),
    ([音频系统], [BGM 播放、音效管理], [张振宇]),
    ([存档系统], [保存/加载、多用户支持], [张振宇]),
    ([关卡设计], [Prologue、Stage 1-3 设计], [张振宇]),
    ([对话脚本], [剧情对话编写], [牛浩羽、张振宇]),
    ([测试], [功能测试、Bug 反馈], [牛浩羽]),
  ),
)

*里程碑*：游戏核心机制完成，前 3 关可玩

== 第三周（9月7日-9月13日）

#styled-table(
  columns: (1fr, 3fr, 1fr),
  headers: ([任务], [内容], [负责人]),
  rows: (
    ([时间回溯], [TimeTravel 系统、幽灵玩家], [张振宇]),
    ([成就系统], [成就解锁、通知显示], [张振宇]),
    ([关卡编辑器], [可视化关卡设计工具], [张振宇]),
    ([关卡完善], [Stage 4-5、Extra 关卡], [张振宇]),
    ([Boss 战], [弹幕系统、Boss 逻辑], [张振宇]),
    ([结局分支], [多结局实现、线索收集], [张振宇]),
    ([UI 优化], [暂停界面、帮助界面、通知系统], [张振宇]),
    ([全面测试], [兼容性测试、性能测试、流程测试], [牛浩羽、张振宇]),
    ([文档编写], [项目文档、技术文档、用户指南], [张振宇]),
  ),
)

*里程碑*：游戏完整可玩，所有功能实现，通过全面测试

= 测试与质量保证

== 测试策略

=== 单元测试
- 核心算法测试（碰撞检测、向量运算）
- 数据结构测试（状态序列化）

=== 集成测试
- 模块交互测试（对话系统 + 游戏引擎）
- 系统集成测试（存档 + 关卡切换）

=== 功能测试
- 游戏流程测试（开始 → 结局）
- 交互功能测试（对话、暂停、存档）
- 特殊机制测试（时间回溯、多结局）

=== 性能测试
- 帧率测试（目标：稳定 60 FPS）
- 内存测试（避免内存泄漏）
- 加载时间测试

=== 兼容性测试
- 浏览器测试（Chrome、Firefox、Edge）
- 操作系统测试（Windows、macOS、Linux）
- 分辨率测试（1280×720 到 1920×1080）

=== 用户测试
- 邀请 5-10 名玩家进行封闭测试
- 收集可读性、可玩性反馈
- 根据反馈进行调整优化

== 质量标准

- *代码质量*：遵循 ES6+ 规范，模块化设计，注释完整
- *性能标准*：60 FPS，加载时间 < 5 秒
- *兼容性*：主流浏览器完全支持
- *用户体验*：操作流畅，反馈及时，界面友好

= 风险管理

== 技术风险

#styled-table(
  columns: (2fr, 1fr, 2fr),
  headers: ([风险], [等级], [应对策略]),
  rows: (
    ([Canvas 性能不足], [中], [优化渲染流程，使用离屏 Canvas，考虑 WebGL]),
    ([浏览器兼容性问题], [低], [使用标准 API，提供降级方案]),
    ([时间回溯实现复杂], [高], [简化设计，分阶段实现，充分测试]),
    ([存档数据损坏], [中], [数据校验，错误处理，备份机制]),
  ),
)

== 进度风险

#styled-table(
  columns: (2fr, 1fr, 2fr),
  headers: ([风险], [等级], [应对策略]),
  rows: (
    ([开发进度延迟], [中], [每周 Review，及时调整计划，优先核心功能]),
    ([功能范围蔓延], [中], [明确需求边界，控制变更，聚焦核心玩法]),
    ([人员变动], [低], [文档完善，代码注释，知识共享]),
  ),
)

== 质量风险

#styled-table(
  columns: (2fr, 1fr, 2fr),
  headers: ([风险], [等级], [应对策略]),
  rows: (
    ([Bug 数量过多], [中], [单元测试，集成测试，及时修复]),
    ([用户体验不佳], [中], [用户测试，反馈迭代，UI/UX 优化]),
    ([性能问题], [中], [性能监控，持续优化，压力测试]),
  ),
)

= 项目执行情况总结

== 整体完成度

#info-box(
  type: "success",
)[
  项目按计划完成，所有核心功能均已实现并通过测试。实际开发进度与计划基本一致，部分功能提前完成。
]

== 各阶段执行情况

=== 第一周执行情况

✅ *完成项*：
- 项目架构设计完成
- 资源管理系统（Asset.js）实现
- 事件系统（Keyboard.js）实现
- 对话系统（Dialogue.js）核心功能完成
- 团队网站搭建完成

📝 *实际情况*：
- 开发效率高于预期
- 对话系统功能更加完善
- 增加了文本样式标记功能

=== 第二周执行情况

✅ *完成项*：
- Game2D 核心引擎完成
- 物理系统、碰撞检测实现
- 玩家控制、游戏对象系统完成
- 关卡系统、瓦片地图实现
- 音频管理、存档系统完成
- Prologue 和 Stage 1-3 关卡设计

📝 *实际情况*：
- 关卡编辑器提前开始开发
- 增加了摄像机控制器功能
- 对话系统与游戏引擎集成顺利

=== 第三周执行情况

✅ *完成项*：
- 时间回溯系统完整实现
- 成就系统完成
- 关卡编辑器功能完善
- Stage 4-5 及测试关卡完成
- Boss 战机制实现
- UI 优化（暂停、帮助、通知）
- 全面测试与 Bug 修复
- 技术文档编写

📝 *实际情况*：
- 时间回溯系统比预期更复杂，但最终完美实现
- 关卡编辑器功能超出预期，大幅提升关卡设计效率
- 增加了多个创新玩法和彩蛋

== 超出计划的额外成果

- *关卡编辑器*：功能完善的可视化关卡设计工具
- *瓦片系统*：支持 80+ 种瓦片的地图系统
- *幽灵玩家*：时间回溯产生的玩家残影
- *视差背景*：多层背景视差效果
- *成就系统*：15+ 种成就，增加可玩性
- *帮助系统*：内置操作指南和提示

== 遇到的挑战与解决

#styled-table(
  columns: (2fr, 3fr),
  headers: ([挑战], [解决方案]),
  rows: (
    (
      [时间回溯状态序列化],
      [设计了完整的状态导出/导入机制，支持游戏对象的深度克隆]
    ),
    (
      [Canvas 渲染性能],
      [引入渲染组缓存、离屏 Canvas、瓦片预渲染等优化策略]
    ),
    (
      [关卡设计效率],
      [开发关卡编辑器，提供可视化设计和代码导出功能]
    ),
    (
      [对话系统灵活性],
      [设计事件驱动的 JSON 格式，支持复杂的剧情控制]
    ),
    (
      [多浏览器兼容性],
      [使用标准 Web API，避免浏览器特定功能，充分测试]
    ),
  ),
)

== 计划调整说明

#info-box(
  type: "info",
)[
  原计划中的"弹幕 Boss 战"因时间和技术复杂度考虑，简化为基于关卡机制的 Boss 战。但增加了更多的关卡内容和交互机制作为补偿。
]

= 项目成果

== 游戏特色

- *创新的时间回溯机制*：玩家可以回到过去改变历史
- *多结局分支*：5 种不同结局，增加重玩价值
- *丰富的关卡设计*：7+ 个精心设计的关卡
- *完整的视觉小说系统*：支持角色立绘、表情切换、样式标记
- *成就系统*：15+ 种成就，鼓励探索
- *关卡编辑器*：为玩家提供创作工具

== 技术亮点

- *模块化架构*：清晰的模块划分，易于维护和扩展
- *双循环设计*：逻辑与渲染分离，保证性能稳定
- *状态管理*：完整的游戏状态序列化与反序列化
- *性能优化*：渲染组缓存、离屏 Canvas、瓦片预渲染
- *开发工具*：关卡编辑器、调试模式、性能监控

== 文档质量

- *技术文档*：10+ 个模块的详细 API 文档（Typst 格式）
- *开发日志*：记录开发过程和关键决策
- *用户指南*：对话脚本编写指南、关卡编辑器使用说明
- *项目文档*：项目计划、设计文档、总结文档

= 未来展望

== 短期优化

- 增加更多关卡和剧情内容
- 优化移动端适配
- 添加更多音效和背景音乐
- 完善弹幕系统

== 长期规划

- 多语言支持
- 在线排行榜
- 关卡分享平台
- 社区功能

#pagebreak()

= 附录

== 技术栈清单

- HTML5
- CSS3（Grid、Flexbox、Animation）
- ES6+ JavaScript（Module、Class、Promise、Async/Await）
- Canvas 2D API
- Web Audio API
- LocalStorage API

== 代码统计

#styled-table(
  columns: (2fr, 1fr, 1fr),
  headers: ([模块], [文件数], [代码行数（估）]),
  rows: (
    ([游戏引擎], [20+], [5000+]),
    ([对话系统], [3], [800+]),
    ([资源管理], [1], [300+]),
    ([UI 系统], [5], [1000+]),
    ([关卡编辑器], [2], [2500+]),
    ([关卡数据], [10+], [3000+]),
    ([文档], [15+], [8000+]),
    ([*总计*], [*56+*], [*20000+*]),
  ),
)

== 资源统计

#styled-table(
  columns: (2fr, 1fr),
  headers: ([资源类型], [数量]),
  rows: (
    ([背景图片], [15+]),
    ([角色立绘], [50+]),
    ([瓦片素材], [80+]),
    ([精灵图], [10+]),
    ([音频文件], [8]),
    ([对话脚本], [10+]),
  ),
)
